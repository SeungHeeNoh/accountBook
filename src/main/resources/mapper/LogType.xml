<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sweethome.accountbook.mapper.LogTypeMapper">
    <select id="findByParam" parameterType="com.sweethome.accountbook.domain.LogType" resultMap="com.sweethome.accountbook.mapper.ResultMaps.logTypeResultMap">
        SELECT
            type_id,
            type_name,
            is_deposit,
            description,
            (select * from log_type where parent_type_id = type_id) parentTypeName,
            created_at,
            created_by,
            modified_at,
            modified_by
        FROM log_type
        <where>
            <if test="typeId != null">
                and type_id = #{typeId}
            </if>
            <if test="typeName != null">
                and typeName = #{typeName}
            </if>
            <if test="isDeposit != null">
                and is_deposit = #{isDeposit}
            </if>
            <if test="description != null">
                and description like concat('%', #{description}, '%')
            </if>
            <if test="auditInfo != null and auditInfo.createdBy != null">
                and created_by like concat('%', #{auditInfo.createdBy}, '%')
            </if>
            <if test="auditInfo != null and auditInfo.modifiedBy != null">
                and modified_by like concat('%', #{auditInfo.modifiedBy}, '%')
            </if>
            <if test="parentTypeId != null">
                and parentTypeId = #{parentTypeId}
            </if>
            and group_seq = #{userGroup.groupSeq}
        </where>
        ORDER BY created_at desc;
    </select>
    <insert id="insert" parameterType="com.sweethome.accountbook.domain.LogType">
        INSERT INTO log_type(type_id, type_name, transaction_type, description, created_at, created_by, parent_type_id, log_group_id)
        VALUES (#{typeId}, #{typeName}, #{transactionType}, #{description}, NOW(), #{auditInfo.createdBy}, #{parentTypeId}, #{userGroup.groupSeq});
    </insert>
    <update id="update" parameterType="com.sweethome.accountbook.domain.LogType">
        UPDATE log_type
        SET
            type_name = #{typeName}
         ,  transaction_type = #{transactionType}
         ,  description = #{description}
         ,  modified_at = NOW()
         ,  modified_by = #{auditInfo.modifiedBy}
         ,  parent_type_id = #{parentTypeId}
        WHERE type_id = #{typeId}
          and group_seq = #{userGroup.userGroup.groupSeq}
    </update>
    <delete id="delete">
        DELETE FROM log_type
        WHERE type_id = #{typeId}
          and group_seq = #{userGroup.userGroup.groupSeq}
    </delete>
</mapper>